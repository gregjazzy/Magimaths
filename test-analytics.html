<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Analytics - MagiMaths</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .button { background: #3b82f6; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin: 5px; }
        .button:hover { background: #2563eb; }
        .result { background: #f3f4f6; padding: 15px; margin: 10px 0; border-radius: 5px; white-space: pre-wrap; }
        .success { border-left: 4px solid #10b981; }
        .error { border-left: 4px solid #ef4444; }
        .status { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 12px; margin-left: 10px; }
        .status.green { background: #dcfce7; color: #166534; }
        .status.red { background: #fecaca; color: #991b1b; }
    </style>
</head>
<body>
    <h1>üß™ Test du Syst√®me Analytics</h1>
    <p>Utilisez cette page pour tester toutes les fonctionnalit√©s analytics avant le d√©ploiement.</p>

    <div id="status">
        <h2>√âtat du Syst√®me</h2>
        <p>Backend: <span id="backend-status" class="status">V√©rification...</span></p>
        <p>Base de donn√©es: <span id="db-status" class="status">V√©rification...</span></p>
        <p>Tracking: <span id="tracking-status" class="status">V√©rification...</span></p>
    </div>

    <div>
        <h2>üîÑ Tests de Base</h2>
        <button class="button" onclick="testVisitorTracking()">1. Tester Tracking Visiteur</button>
        <button class="button" onclick="testPageView()">2. Tester Vue de Page</button>
        <button class="button" onclick="simulateMultipleVisits()">3. Simuler Visites Multiples</button>
    </div>

    <div>
        <h2>üìä R√©cup√©ration de Donn√©es</h2>
        <button class="button" onclick="getDailyStats()">Stats Quotidiennes</button>
        <button class="button" onclick="getMonthlyStats()">Stats Mensuelles</button>
        <button class="button" onclick="getDashboardData()">Dashboard Complet</button>
    </div>

    <div>
        <h2>üö® Tests d'Alertes</h2>
        <button class="button" onclick="detectAlerts()">D√©tecter Alertes</button>
        <button class="button" onclick="getActiveAlerts()">Voir Alertes Actives</button>
        <button class="button" onclick="simulateSuspiciousActivity()">Simuler Activit√© Suspecte</button>
    </div>

    <div>
        <h2>üóÑÔ∏è Base de Donn√©es</h2>
        <button class="button" onclick="checkTables()">V√©rifier Tables</button>
        <button class="button" onclick="getVisitorSessions()">Voir Sessions Visiteurs</button>
        <button class="button" onclick="getPageAnalytics()">Voir Analytics Pages</button>
    </div>

    <div id="results">
        <h2>üìù R√©sultats</h2>
        <div id="output"></div>
    </div>

    <script>
        // Configuration
        const API_BASE = window.location.origin;
        let visitorSessionId = null;

        // Fonction utilitaire pour afficher les r√©sultats
        function displayResult(title, data, isError = false) {
            const output = document.getElementById('output');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'result ' + (isError ? 'error' : 'success');
            resultDiv.innerHTML = `<strong>${title}</strong>\n${JSON.stringify(data, null, 2)}`;
            output.appendChild(resultDiv);
            output.scrollTop = output.scrollHeight;
        }

        function updateStatus(element, text, isSuccess) {
            const el = document.getElementById(element);
            el.textContent = text;
            el.className = 'status ' + (isSuccess ? 'green' : 'red');
        }

        // V√©rifications initiales
        async function checkSystemStatus() {
            try {
                // Test backend
                const response = await fetch(`${API_BASE}/api/analytics/dashboard`);
                updateStatus('backend-status', 'En ligne', response.ok);
                
                if (response.ok) {
                    const data = await response.json();
                    updateStatus('db-status', 'Connect√©e', true);
                    updateStatus('tracking-status', 'Pr√™t', true);
                } else {
                    updateStatus('db-status', 'Erreur', false);
                    updateStatus('tracking-status', 'Erreur', false);
                }
            } catch (error) {
                updateStatus('backend-status', 'Hors ligne', false);
                updateStatus('db-status', 'Erreur', false);
                updateStatus('tracking-status', 'Erreur', false);
            }
        }

        // Tests de tracking
        async function testVisitorTracking() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/visit`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                visitorSessionId = data.visitorSessionId;
                displayResult('‚úÖ Tracking Visiteur', data);
            } catch (error) {
                displayResult('‚ùå Erreur Tracking Visiteur', error, true);
            }
        }

        async function testPageView() {
            if (!visitorSessionId) {
                await testVisitorTracking();
            }

            try {
                const response = await fetch(`${API_BASE}/api/analytics/page-view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visitorSessionId,
                        pageType: 'chapter',
                        pageId: 'test-chapter-analytics',
                        pageTitle: 'Test Analytics Chapter',
                        classLevel: 'cp',
                        timeSpent: 120
                    })
                });
                
                const data = await response.json();
                displayResult('‚úÖ Vue de Page Track√©e', data);
            } catch (error) {
                displayResult('‚ùå Erreur Vue de Page', error, true);
            }
        }

        async function simulateMultipleVisits() {
            displayResult('üîÑ Simulation Visites Multiples', 'D√©marrage...');
            
            for (let i = 0; i < 15; i++) {
                await fetch(`${API_BASE}/api/analytics/visit`, { method: 'POST' });
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            displayResult('‚úÖ Visites Multiples Simul√©es', '15 visites cr√©√©es');
        }

        // R√©cup√©ration de donn√©es
        async function getDailyStats() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/daily-stats?days=7`);
                const data = await response.json();
                displayResult('üìä Stats Quotidiennes (7 jours)', data);
            } catch (error) {
                displayResult('‚ùå Erreur Stats Quotidiennes', error, true);
            }
        }

        async function getMonthlyStats() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/monthly-stats?months=3`);
                const data = await response.json();
                displayResult('üìä Stats Mensuelles (3 mois)', data);
            } catch (error) {
                displayResult('‚ùå Erreur Stats Mensuelles', error, true);
            }
        }

        async function getDashboardData() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/dashboard`);
                const data = await response.json();
                displayResult('üìä Dashboard Complet', data);
            } catch (error) {
                displayResult('‚ùå Erreur Dashboard', error, true);
            }
        }

        // Tests d'alertes
        async function detectAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/alerts?action=detect`);
                const data = await response.json();
                displayResult('üö® D√©tection Alertes', data);
            } catch (error) {
                displayResult('‚ùå Erreur D√©tection Alertes', error, true);
            }
        }

        async function getActiveAlerts() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/alerts?action=list`);
                const data = await response.json();
                displayResult('üö® Alertes Actives', data);
            } catch (error) {
                displayResult('‚ùå Erreur Alertes Actives', error, true);
            }
        }

        async function simulateSuspiciousActivity() {
            displayResult('üö® Simulation Activit√© Suspecte', 'Cr√©ation de 25 visites rapides...');
            
            // Cr√©er une session
            const visitResponse = await fetch(`${API_BASE}/api/analytics/visit`, { method: 'POST' });
            const visitData = await visitResponse.json();
            const sessionId = visitData.visitorSessionId;
            
            // Cr√©er 25 vues de pages rapidement
            for (let i = 0; i < 25; i++) {
                await fetch(`${API_BASE}/api/analytics/page-view`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        visitorSessionId: sessionId,
                        pageType: 'chapter',
                        pageId: `suspicious-${i}`,
                        pageTitle: `Page Suspecte ${i}`,
                        classLevel: 'test'
                    })
                });
                await new Promise(resolve => setTimeout(resolve, 50));
            }
            
            displayResult('‚úÖ Activit√© Suspecte Simul√©e', '25 vues de pages en 1.25 secondes');
        }

        // V√©rifications base de donn√©es
        async function checkTables() {
            // Simuler la v√©rification des tables via les APIs
            try {
                const tests = [
                    { name: 'visitor_sessions', test: () => fetch(`${API_BASE}/api/analytics/visit`, { method: 'POST' }) },
                    { name: 'page_analytics', test: () => fetch(`${API_BASE}/api/analytics/dashboard`) },
                    { name: 'security_alerts', test: () => fetch(`${API_BASE}/api/analytics/alerts?action=list`) }
                ];
                
                const results = {};
                for (const test of tests) {
                    try {
                        const response = await test.test();
                        results[test.name] = response.ok ? '‚úÖ OK' : '‚ùå Erreur';
                    } catch (error) {
                        results[test.name] = '‚ùå Erreur';
                    }
                }
                
                displayResult('üóÑÔ∏è V√©rification Tables', results);
            } catch (error) {
                displayResult('‚ùå Erreur V√©rification Tables', error, true);
            }
        }

        async function getVisitorSessions() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/dashboard`);
                const data = await response.json();
                displayResult('üë• Sessions Visiteurs', {
                    total: data.totalVisitors,
                    weekly: data.weeklyStats,
                    countries: data.visitorsByCountry
                });
            } catch (error) {
                displayResult('‚ùå Erreur Sessions Visiteurs', error, true);
            }
        }

        async function getPageAnalytics() {
            try {
                const response = await fetch(`${API_BASE}/api/analytics/dashboard`);
                const data = await response.json();
                displayResult('üìÑ Analytics Pages', {
                    totalViews: data.totalPageViews,
                    topClasses: data.topClasses,
                    topChapters: data.topChapters
                });
            } catch (error) {
                displayResult('‚ùå Erreur Analytics Pages', error, true);
            }
        }

        // Initialisation
        window.onload = function() {
            checkSystemStatus();
            displayResult('üöÄ Page de Test Charg√©e', 'Syst√®me pr√™t pour les tests');
        };
    </script>
</body>
</html>